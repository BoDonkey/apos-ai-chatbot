/**
 * @fileoverview Main ingestion pipeline with OpenAPI support
 */

import dotenv from 'dotenv';
import { requireEnv, createLogger } from '@apos-chatbot/shared';
import { weaviateClient } from './weaviate/client.js';
import { scrapeDocumentation } from './scrapers/playwright-scraper.js';
import { processScrapedPages } from './processors/chunk-processor.js';
import { processOpenAPISpec } from './processors/openapi-processor.js';

dotenv.config();

const logger = createLogger('Ingestion');

/**
 * Main ingestion pipeline
 */
async function main() {
  try {
    logger.info('Starting ingestion pipeline');

    // Initialize Weaviate
    const weaviateUrl = requireEnv('WEAVIATE_URL');
    const weaviateApiKey = process.env.WEAVIATE_API_KEY;

    await weaviateClient.initialize(weaviateUrl, weaviateApiKey);

    // Check current document count
    const currentCount = await weaviateClient.getCount();
    logger.info(`Current document count: ${currentCount}`);

    // Optionally clear existing data
    const shouldClear = process.argv.includes('--clear');
    if (shouldClear) {
      logger.warn('Clearing existing documents');
      await weaviateClient.deleteAll();
    }

    // Parse CLI flags
    const includeAstro = process.argv.includes('--include-astro');
    const includeOpenAPI = process.argv.includes('--include-openapi');
    const openAPIPath = process.env.OPENAPI_SPEC_PATH || './openapi.json';

    // Scrape ApostropheCMS docs
    logger.info('Scraping ApostropheCMS documentation');
    const aposPages = await scrapeDocumentation({
      baseUrl: requireEnv('DOCS_BASE_URL', 'https://docs.apostrophecms.org'),
      sitemapUrl: 'https://docs.apostrophecms.org/sitemap.xml',
      maxDepth: 3,
      maxPages: 500,
      allowedDomains: [
        'apostrophecms.com/docs',
        'docs.apostrophecms.org'
      ],
      excludePatterns: [
        '/search',
        '/api-examples',
        '/markdown-examples',
        '/404'
      ],
      delayMs: 100
    });

    logger.info(`Scraped ${aposPages.length} ApostropheCMS pages`);

    // Process and chunk pages
    const aposDocuments = processScrapedPages(aposPages, {
      maxChunkSize: 1000,
      overlap: 200
    });

    // Import to Weaviate
    logger.info('Importing documents to Weaviate');
    await weaviateClient.batchImport(aposDocuments);

    // Optional: Process Astro docs from llms-full.txt
    if (includeAstro) {
      const astroDocsUrl = process.env.ASTRO_DOCS_URL || 'https://docs.astro.build/llms-full.txt';
      logger.info('Fetching Astro documentation from llms-full.txt');
      
      // Import the llms-full processor
      const { processLlmsFullTxt } = await import('./processors/llms-full-processor.js');
      
      const astroPages = await processLlmsFullTxt(astroDocsUrl);
      logger.info(`Processed ${astroPages.length} Astro sections`);

      const astroDocuments = processScrapedPages(astroPages, {
        maxChunkSize: 1000,
        overlap: 200
      });

      await weaviateClient.batchImport(astroDocuments);
    }

    // Optional: Process OpenAPI spec
    if (includeOpenAPI) {
      logger.info(`Processing OpenAPI spec from: ${openAPIPath}`);
      
      try {
        const openApiPages = await processOpenAPISpec(openAPIPath);
        logger.info(`Processed ${openApiPages.length} OpenAPI pages`);

        const openApiDocuments = processScrapedPages(openApiPages, {
          maxChunkSize: 1000,
          overlap: 200
        });

        await weaviateClient.batchImport(openApiDocuments);
      } catch (error) {
        logger.error('Failed to process OpenAPI spec', error);
        logger.warn('Continuing with other sources...');
      }
    }

    // Final statistics
    const finalCount = await weaviateClient.getCount();
    logger.info(`Ingestion complete. Total documents: ${finalCount}`);
    logger.info(`New documents added: ${finalCount - currentCount}`);

  } catch (error) {
    logger.error('Ingestion pipeline failed', error);
    process.exit(1);
  }
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

export { main };
